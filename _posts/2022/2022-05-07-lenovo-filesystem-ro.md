---
layout: post
title: Lenovo 노트북에서 리눅스 사용시 파일시스템 ro 문제 삽질노트
category: settings
tags:
- linux
- Wi-Fi
- lenovo
- NVMe
- APST
date: 2022-05-07 18:46:28 +0900
---

원래 쓰던 HP 노트북이 와이파이 모듈이 죽어서 결국 새 노트북을 작년 12월 부터 5개월 동안 쓰고 있었지만 리눅스를 사용하다 보면 파일시스템에 문제가 생겼다며 읽기 전용으로 재마운트가 되었다는 메시지가 뜨는 문제가 계속 발생했다. 지금 생각해보면 정상적인 시스템 종료도 안 되었으니 읽기조차 안 되는 상태였다.

문제의 원인이 뭔지 계속 찾아봤는데 일단 리얼텍의 무선랜 칩이 우분투에서 제공하던 커널 버전에선 지원이 안 되어서 rtw89 드라이버를 수동으로 설치 했었다. 그러다가 mainline이라는 툴을 이용해서 커널 5.16.3 버전을 이용했을 땐 문제가 없었다.

그러다가 우분투 22.04로 업그레이드 후에 또 문제가 터졌는데 이번에는 커널 버전을 똑같이 맞춰도 계속 터져서 스트레스가 꽤나 쌓인 상태였다.
결국 시스템을 깨끗하게 밀어버리기로 결정했고 페도라를 설치했으나 문제가 계속 발생했다.
여러가지 삽질 끝에 알아낸 조건들은 다음과 같다.

- 와이파이를 아예 꺼놓고 USB 테더링을 이용하거나 유선랜을 사용하면 문제가 발생하지 않는다
- SSD를 아예 사용하지 않고 USB 부팅을 사용해도 문제가 발생하지 않는다
- 인텔 8265NGW 칩으로 바꾸면 6E가 아니라 Wi-Fi 5까지만 지원하지만 문제가 덜 생긴다
- 인텔 AX210 칩으로 바꾸면 드라이버 문제는 해결 되지만 문제는 여전하다

결국 레노버 노트북의 PCI 관련 문제인 것 같았고 결론적으로 절반은 맞은 셈이 되었다.
나랑 똑같은 문제를 겪는 사람을 발견했고[^1], APSTE를 끄면 해결된다는 이야기가 있었다.
APSTE에 대해 찾아보니 E는 모르겠고 APST에 대한 이야기가 나왔는데[^2], `smartctl -a /dev/nvme0` 명령을 이용해서 지원하는 절전모드의 한계값을 찾아 부팅 할 때 커널 파라미터로 `nvme_core.default_ps_max_latency_us=0`를 넣어 주면 해결 된다고 한다.

결론적으로 문서에서 나온대로 얻은 값인 2000은 사용해도 터지고 0으로 완전 비활성화를 하니 문제가 해결은 되었다. 이게 근본적인 해결책은 되지 못하는 게, NVMe 장치가 한 머신에 하나만 있는 것도 아닌데 일괄적으로 비활성화를 하게 되면 당연히 시스템 전원관리에 좋지는 않다. 하지만 노트북이라 NVMe 장치를 더 추가할 수는 없으니 결국은 이 파라미터를 넣거나 NVMe SSD를 교체해야 하는 것이었다. 별개로 레노버에 내장된 OEM SSD가 문제가 많다고 하니 조만간 교체해버릴 예정이다.

원래 노트북을 사면 항상 뭔가가 불만이었지만 레노버는 배송부터 문제였고 웬만하면 피하고 싶은 업체가 되었다. 우분투 인증을 받았다고 하는데 같은 모델 내에서 커스텀을 어찌저찌 잘 맞춘 상태에서만 받은 것 같다.

별개로 레노버 노트북을 분해하면서 고정핀을 거의 다 부셔버렸다. 애초에 나사로 고정이 되어 있는데 굳이 안 열리게 하는 고정핀을 90도 각도로 만들 이유가 있나 싶다. 그냥 45도 정도의 삼각형 모양으로 소프트 락을 걸었어도 안 벌어졌을텐데 말이다. 심지어 고정핀이 엄청 얇고 가늘어서 열면 무조건 부서지는 수준이다.
문제는 와이파이 칩을 변경하는 커스텀 주문을 넣거나 하면 이걸 조립해서 주는 게 아니라 부품을 따로 포장해 주고 스스로 열어서 교체하라고 한다는 블로그 글도 있었다. 쉽게 열리지도 않는데 그걸 소비자에게 맡기다니 너무한다는 생각이 들었다.


[^1]: https://askubuntu.com/questions/1395915/thinkpad-t14-amd-gen2-ext4-fs-error/1406934
[^2]: https://wiki.archlinux.org/title/Solid_state_drive/NVMe#Power_Saving_(APST)
